# Сервис для загрузки товаров в формате excel

<!-- ToC start -->
# Обзор

1. [Запуск приложения](#Запуск-приложения)
1. [Запуск линтера](#Запуск-линтера)
1. [Реализация](#Реализация)
1. [Усложнения](#Реализация)
1. [Используемые библиотеки](#Используемые-библиотеки)
1. [API](#API)
<!-- ToC end -->

# Запуск приложения
```
docker-compose up
``` 

# Запуск линтера
Предварительно необходимо установить линтер в локальный репозиторий командой:
```
make lint-prepare
```
Запуск линтера:
```
make lint
```

# Юнит-тесты
Запуск юнит-тестов:
```
make test
```

# Реализация
- Язык программирования Go
- База данных PostgreSQL
- HTTP JSON API
# Усложнения
- Следование принципам подхода "Чистая архитектура"
- Bulk вставка и удаление (вставка и удаление нескольких записей одним SQL запросом)
- Покрытие кода Юнит тестами
- Использование индексов БД (создание в файле init.sql)
- Докеризация приложения и запуск с помощью `docker-compose`
- Многоэтапная сборка Docker-образа сервиса
- Использование переменных окружения для конфигурации приложения (One of The Twelve-Factor App)
- Использование линтера `golangci-lint`
- Логирование HTTP запросов с помощью middleware
# Используемые библиотеки
- Веб-фреймворк `echo`
- Конфигурирование приложения - библиотека `viper`
- `sqlx` для работы с БД
- Генерация mock-объектов для unit-тестирования - `mockery`
- Логирование с помощью `zerolog`

# API
## Асинхронный вариант
### POST /offers/async
**Асинхронная загрузка товаров в формате Excel.**
Принимает на вход ссылку на файл и id продавца, к чьему аккаунту будут привязаны загружаемые товары. Сервис читает файл и сохраняет, либо обновляет товары в БД. Обновление будет происходить, если пара (id продавца, offer_id) уже есть у нас в базе. 

```
{
    "seller_id": "string",
    "url": "string"
}
```
В ответ на запрос выдает ID задачи, которая будет выполнять данную загрузку.

Запрос:
```
curl --request POST 'localhost:9090/offers/async' \
--header 'Content-Type: application/json' \
--data-raw '{
    "seller_id": "1",
    "url": "https://docs.google.com/spreadsheets/d/1QmDcIfAfJprYG2ZPgmOoGRqbggw3rJ5b9yi3iW_oP-U/export?format=xlsx"
}'
```
Ответ:
```
{
  "task_id": 1
}
```

### GET /tasks/:id
**Получение задачи загрузки по taskId.**
#### Пример запроса и ответа
Запрос:
```
curl --location --request GET 'localhost:9090/tasks/1'
```
Ответ:
```
{
    "status": "done",
    "statistic": {
        "created_count": 0,
        "updated_count": 6,
        "deleted_count": 7,
        "err_count": 1
    }
}
```

## Синхронный вариант
### POST /offers
**Загрузка товаров в формате Excel.**
Принимает на вход ссылку на файл и id продавца, к чьему аккаунту будут привязаны загружаемые товары. Сервис читает файл и сохраняет, либо обновляет товары в БД. Обновление будет происходить, если пара (id продавца, offer_id) уже есть у нас в базе. 

В ответ на запрос выдаёт краткую статистику: количество созданных товаров, обновлённых, удалённых и количество строк с ошибками (например цена отрицательная, либо вообще не число).
```
{
    "seller_id": "string",
    "url": "string"
}
```

#### Пример запроса и ответа
Запрос:
```
curl --request POST 'localhost:9090/offers' \
--header 'Content-Type: application/json' \
--data-raw '{
    "seller_id": "1",
    "url": "https://docs.google.com/spreadsheets/d/1QmDcIfAfJprYG2ZPgmOoGRqbggw3rJ5b9yi3iW_oP-U/export?format=xlsx"
}'
```
Ответ:
```
{
  "statistic": {
    "created_count": 13,
    "updated_count": 0,
    "deleted_count": 0,
    "err_count": 1
  }
}
```

### GET /offers
**Получить список товаров из базы.**
Принимает на вход id продавца, offer_id, подстрока названия товара (по тексту "теле" находились и "телефоны", и "телевизоры").
```
{
    "seller_id": "string",
    "offer_id": "string",
    "name": "string"
}
```
#### Пример запроса и ответа
Запрос:
```
curl --request GET 'localhost:9090/offers' \
--header 'Content-Type: application/json' \
--data-raw '{
    "offer_ids": "1"
}'
```
Ответ:
```
{
  "offers": [
    {
      "seller_id": "1",
      "offer_id": "13",
      "name": "Macbook_13",
      "price": 13000,
      "quantity": 333
    },
    {
      "seller_id": "1",
      "offer_id": "3",
      "name": "Macbook_3",
      "price": 3000,
      "quantity": 33
    },
    ...
  ]
}
```
